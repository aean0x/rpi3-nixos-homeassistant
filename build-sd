#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

# Check if settings.nix repoUrl matches current git remote
echo "Validating settings.nix..."
CURRENT_REMOTE=$(git remote get-url origin 2>/dev/null | sed -E 's|.*github\.com[:/]([^/]+/[^/.]+)(\.git)?|\1|')
SETTINGS_REPO=$(grep -oP 'repoUrl\s*=\s*"\K[^"]+' settings.nix 2>/dev/null || echo "")

if [ -n "$CURRENT_REMOTE" ] && [ -n "$SETTINGS_REPO" ] && [ "$CURRENT_REMOTE" != "$SETTINGS_REPO" ]; then
    echo ""
    echo "WARNING: settings.nix repoUrl doesn't match your git remote."
    echo "  settings.nix: $SETTINGS_REPO"
    echo "  git remote:   $CURRENT_REMOTE"
    echo ""
    echo "Edit settings.nix now? [Y/n] "
    read -r response
    if [[ ! "$response" =~ ^[Nn]$ ]]; then
        nano settings.nix
        echo ""
        echo "Remember to commit and push to remote before building!"
        echo "Press Enter to continue or Ctrl+C to abort..."
        read -r
    fi
fi

# Ensure secrets are set up
echo "Setting up SOPS encryption..."
cd secrets
./encrypt
cd ..

# Find key (same logic as secrets/encrypt)
if [ -r "$(pwd)/secrets/key.txt" ]; then
    KEY_PATH="$(pwd)/secrets/key.txt"
    echo "Using key: secrets/key.txt"
elif [ -r /var/lib/sops-nix/key.txt ]; then
    KEY_PATH="/var/lib/sops-nix/key.txt"
    echo "Using key: /var/lib/sops-nix/key.txt"
else
    if [ -f /var/lib/sops-nix/key.txt ]; then
        echo "Error: /var/lib/sops-nix/key.txt exists but is not readable"
        echo "Fix with: sudo cp /var/lib/sops-nix/key.txt secrets/key.txt && sudo chown \$USER secrets/key.txt"
    else
        echo "Error: No key found in secrets/key.txt or /var/lib/sops-nix/key.txt"
    fi
    exit 1
fi

# Build SD image with key path for injection
export KEY_FILE_PATH="$KEY_PATH"
echo "Building SD card image..."
nix build .#packages.aarch64-linux.sdImage --impure

echo ""
echo "SD image built successfully!"
echo ""
echo "Output: result/sd-image/*.img.zst"
echo ""
echo "Flash to SD card with:"
echo "  zstdcat result/sd-image/*.img.zst | sudo dd of=/dev/sdX bs=4M status=progress"
echo ""
echo "Replace /dev/sdX with your SD card device."
